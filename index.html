<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="logodepesta√±a/Captura de pantalla 2025-11-19 143222.ico" type="image/png">
    <title>Market</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <h1 id="loginStoreName">Market</h1>
            <h2>Ingrese su PIN</h2>
            <input type="password" id="loginPinInput" class="pin-input" maxlength="32" placeholder="Ingrese PIN">
            <button onclick="login()" class="btn-primary">Ingresar</button>
            <p id="loginError" class="error-message"></p>
        </div>
    </div>

    <!-- Aplicaci√≥n Principal -->
    <div id="mainApp" class="main-app" style="display: none;">
        <!-- Encabezado -->
        <header class="header">
            <h1 id="storeName">Market</h1>
        </header>

        <!-- Barra de Navegaci√≥n -->
        <nav class="navbar">
            <button onclick="showSection('nuevaVenta')" class="nav-btn active" id="navNuevaVenta">Nueva Venta</button>
            <button onclick="showSection('inventario')" class="nav-btn" id="navInventario">Inventario</button>
            <button class="nav-btn" id="navBackup" onclick="mostrarPanelBackup()" title="Gestionar backups y exportar datos">üíæ Backup</button>
            <button onclick="showSection('configuracion')" class="nav-btn" id="navConfiguracion">Configuraci√≥n</button>
        </nav>

        <!-- Ventana Nueva Venta -->
        <div id="nuevaVenta" class="section active">
            <div class="nueva-venta-container">
                <div class="search-section">
                    <input type="text" id="searchInput" class="search-input" placeholder="Buscar por nombre o c√≥digo...">
                    <button onclick="addProductToCart()" class="btn-add">Agregar</button>
                    <div id="searchResults" class="search-results"></div>
                </div>

                <div class="cart-section">
                    <h2>Carrito</h2>
                    <div id="cartContainer" class="cart-container" onclick="activateScanner()">
                        <table class="cart-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Tama√±o</th>
                                    <th>Cantidad (Unds)</th>
                                    <th>Precio/U</th>
                                    <th>Precio</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="cartBody">
                            </tbody>
                        </table>
                    </div>
                    <p class="scanner-status" id="scannerStatus"></p>
                </div>

                <div class="payment-section">
                    <div class="total-container">
                        <h3>Total</h3>
                        <p class="total-amount" id="totalAmount">$0.00</p>
                        <p class="converted-amount" id="convertedAmount"></p>
                    </div>
                    <div class="payment-buttons">
                        <button onclick="registerSale('Punto de Venta')" class="btn-payment">Punto de Venta</button>
                        <button onclick="registerSale('Transferencia')" class="btn-payment">Transferencia</button>
                        <button onclick="registerSale('Pago P2P')" class="btn-payment">Pago P2P</button>
                        <button onclick="registerSale('Efectivo')" class="btn-payment">Efectivo</button>
                        <button onclick="registerSale('Biopago')" class="btn-payment">Biopago</button>
                        <button onclick="registerSale('Divisas')" class="btn-payment">Divisas</button>
                    </div>
                    <button onclick="cancelSale()" class="btn-cancel">Cancelar Venta</button>
                </div>
            </div>
        </div>

        <!-- Ventana Inventario -->
        <div id="inventario" class="section">
            <div class="inventory-container">
                <div class="inventory-sidebar" id="inventorySidebar">
                    <p class="sidebar-placeholder">Seleccione un producto para ver detalles</p>
                </div>
                <div class="inventory-grid" id="inventoryGrid">
                    
                </div>
            </div>
            <div class="inventory-navbar">
                <button onclick="showAddProductModal()" class="btn-inventory">Agregar Producto</button>
                <button onclick="deleteInventory()" class="btn-inventory">Eliminar Inventario</button>
                <button onclick="editInventory()" class="btn-inventory">Editar Inventario</button>
                <button onclick="printInventory()" class="btn-inventory">Imprimir Inventario</button>
            </div>
        </div>

        <!-- Ventana Configuraci√≥n -->
        <div id="configuracion" class="section">
            <div class="config-container">
                <h2>Configuraci√≥n</h2>
                
                <div class="config-group">
                    <label>Moneda a utilizar:</label>
                    <select id="currencySelect" class="config-select">
                        <option value="USD">D√≥lares Estadounidenses (USD)</option>
                        <option value="EUR">Euros (EUR)</option>
                        <option value="BS">Bol√≠vares (Bs)</option>
                    </select>
                </div>

                <div class="config-group">
                    <label>Convertir a:</label>
                    <select id="convertToSelect" class="config-select">
                        <option value="">No convertir</option>
                        <option value="USD">D√≥lares Estadounidenses (USD)</option>
                        <option value="EUR">Euros (EUR)</option>
                        <option value="BS">Bol√≠vares (Bs)</option>
                    </select>
                    <input type="number" id="conversionRate" class="config-input" placeholder="Tasa de conversi√≥n" step="0.01">
                </div>

                <div class="config-group">
                    <label>PIN de autenticaci√≥n:</label>
                    <input type="password" id="newPin" class="config-input" placeholder="Nuevo PIN (4-32 d√≠gitos)" maxlength="32">
                    <input type="password" id="confirmPin" class="config-input" placeholder="Confirmar PIN" maxlength="32">
                </div>

                <div class="config-group">
                    <label>Nombre de la tienda:</label>
                    <input type="text" id="storeNameInput" class="config-input" placeholder="Nombre de la tienda">
                </div>

                <div class="config-group">
                    <label>Aviso de Stock (%):</label>
                    <input type="number" id="stockWarning" class="config-input" value="20" min="1" max="100">
                </div>

                <div class="config-group">
                    <label>Borrar registro de ventas autom√°ticamente:</label>
                    <select id="autoDeleteSales" class="config-select">
                        <option value="never">No borrar nunca</option>
                        <option value="weekly">Borrar cada semana</option>
                        <option value="monthly">Borrar cada mes</option>
                        <option value="yearly">Borrar anualmente</option>
                    </select>
                </div>

                <div class="config-group">
                    <label>Ajuste de impresora (ancho en mm):</label>
                    <input type="number" id="printerWidth" class="config-input" value="55" min="40" max="80">
                </div>

                <div class="config-buttons">
                    <button onclick="saveSettings()" class="btn-config">Guardar Ajustes</button>
                    <button onclick="viewSalesRecord()" class="btn-config">Ver Registro de Ventas</button>
                    <button onclick="exportSalesRecord()" class="btn-config">Exportar Registro (PDF)</button>
                    <button onclick="deleteSalesRecord()" class="btn-config btn-danger">Borrar Registro de Ventas</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Producto -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddProductModal()">&times;</span>
            <h2>Agregar Producto</h2>
            <form id="addProductForm">
                <label>Nombre: *</label>
                <input type="text" id="productName" class="modal-input" required>

                <label>C√≥digo de Barra:</label>
                <input type="text" id="productBarcode" class="modal-input">

                <label>Tama√±o:</label>
                <div class="size-container">
                    <input type="number" id="productSize" class="modal-input size-input" step="0.01">
                    <select id="productSizeUnit" class="modal-select">
                        <option value="L">Litros (L)</option>
                        <option value="mL">Mililitros (mL)</option>
                        <option value="Kg">Kilogramos (Kg)</option>
                        <option value="g">Gramos (g)</option>
                    </select>
                </div>

                <label>Precio: *</label>
                <input type="number" id="productPrice" class="modal-input" step="0.01" required>

                <label>Stock:</label>
                <div class="stock-container">
                    <select id="stockType" class="modal-select" onchange="updateStockInputs()">
                        <option value="units">Unidades</option>
                        <option value="packages">Paquetes</option>
                        <option value="bulk">Bultos</option>
                    </select>
                    <div id="stockInputs">
                        <input type="number" id="stockQuantity" class="modal-input" placeholder="Cantidad" value="0" min="0">
                        <input type="number" id="stockPerContainer" class="modal-input" placeholder="Cant/Contenedor" style="display:none;" value="1" min="1">
                    </div>
                </div>

                <label>Imagen:</label>
                <input type="file" id="productImageFile" class="modal-input" accept="image/*">
                <input type="text" id="productImageUrl" class="modal-input" placeholder="O ingrese URL de imagen">

                <button type="submit" class="btn-primary">Agregar Producto</button>
            </form>
        </div>
    </div>

    <!-- Modal Resumen de Venta -->
    <div id="saleModal" class="modal">
        <div class="modal-content receipt-modal">
            <h2>Resumen de Venta</h2>
            <div id="receiptContent" class="receipt-content"></div>
            <div class="modal-buttons">
                <button onclick="printReceipt()" class="btn-primary">Imprimir Recibo</button>
                <button onclick="continueSale()" class="btn-secondary">Continuar</button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Registro de Ventas -->
    <div id="salesRecordModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close" onclick="closeSalesRecordModal()">&times;</span>
            <h2>Registro de Ventas</h2>
            <div id="salesRecordContent" class="sales-record-content"></div>
        </div>
    </div>
    <!-- script de la app -->

    <!-- =========================================== -->
    <!-- SISTEMA UNIVERSAL - FUNCIONA EN CUALQUIER PC -->
    <!-- =========================================== -->
    
        <!-- 1. CDN de Supabase - A√ëADE ASYNC -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.0/dist/umd/supabase.min.js" async></script>

    <!-- 2. Configuraci√≥n Supabase - MODIFICADA -->
    <script>
        // VARIABLES GLOBALES PARA SUPABASE
        window.SUPABASE_CONFIG = {
            // ‚ö†Ô∏è VERIFICA ESTA URL - TIENE UN ERROR DE TIPEO
            url: 'https://tlzlpwxjzuhamsjmynee.supabase.co',  // La correcta es con Z
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRsemxwd3hqenVoYW1zam15bmVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NzI5MTMsImV4cCI6MjA4NDE0ODkxM30.Hr0ckNblzXfjYCE-r7YKxjQYAQi7rRdCafCOA0MwdMM'
        };
        
        // Variables globales
        window.supabaseClient = null;  // Cambi√© el nombre para evitar confusi√≥n
        window.usarSupabase = false;
        
        // Funci√≥n para INICIALIZAR Supabase - REESCRITA
        function inicializarSupabase() {
            try {
                console.log('üîÑ Inicializando Supabase...');
                
                // Verificar que el CDN se carg√≥
                if (typeof supabase === 'undefined') {
                    console.warn('‚ùå CDN de Supabase no cargado');
                    window.usarSupabase = false;
                    return false;
                }
                
                // Verificar credenciales
                if (!window.SUPABASE_CONFIG.url || !window.SUPABASE_CONFIG.key) {
                    console.warn('‚ùå Credenciales de Supabase no configuradas');
                    window.usarSupabase = false;
                    return false;
                }
                
                // VERIFICAR URL - CORREGIR EL TIPEO
                const urlCorrecta = 'https://tlzlpwxjzuhamsjmynee.supabase.co';
                if (window.SUPABASE_CONFIG.url !== urlCorrecta) {
                    console.warn('‚ö†Ô∏è URL incorrecta, corrigiendo...');
                    window.SUPABASE_CONFIG.url = urlCorrecta;
                }
                
                console.log('üì° URL:', window.SUPABASE_CONFIG.url);
                console.log('üîë Key length:', window.SUPABASE_CONFIG.key.length);
                
                // IMPORTANTE: supabase (del CDN) ya tiene createClient
                // No necesitas desestructurar de window.supabase
                window.supabaseClient = supabase.createClient(
                    window.SUPABASE_CONFIG.url,
                    window.SUPABASE_CONFIG.key
                );
                
                console.log('‚úÖ Supabase inicializado correctamente');
                console.log('üîß Cliente creado:', typeof window.supabaseClient);
                window.usarSupabase = true;
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error inicializando Supabase:', error);
                console.error('Detalles:', error.message);
                window.usarSupabase = false;
                return false;
            }
        }
        
        // Funci√≥n para PROBAR conexi√≥n
        async function probarConexionSupabase() {
            if (!window.supabaseClient) {
                console.log('üì¥ Cliente Supabase no disponible');
                return false;
            }
            
            try {
                console.log('üîç Probando conexi√≥n con Supabase...');
                const { data, error } = await window.supabaseClient
                    .from('productos')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    console.error('‚ùå Error de conexi√≥n:', error.message);
                    console.error('C√≥digo:', error.code);
                    return false;
                }
                
                console.log('‚úÖ Conexi√≥n con Supabase exitosa');
                return true;
                
            } catch (error) {
                console.error('‚ùå Error en prueba de conexi√≥n:', error);
                return false;
            }
        }
        
        // Inicializar cuando la p√°gina cargue - MODIFICADO
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Aplicaci√≥n cargando...');
            
            // Esperar a que el CDN se cargue
            setTimeout(() => {
                const supabaseInicializado = inicializarSupabase();
                
                if (supabaseInicializado) {
                    // Probar conexi√≥n
                    setTimeout(async () => {
                        const conexionExitosa = await probarConexionSupabase();
                        window.usarSupabase = conexionExitosa;
                        
                        if (conexionExitosa) {
                            console.log('üåê Modo: Supabase + localStorage (sincronizado)');
                        } else {
                            console.log('üì¥ Modo: Solo localStorage (sin conexi√≥n)');
                        }
                    }, 500);
                } else {
                    console.log('üì¥ Modo: Solo localStorage (Supabase no configurado)');
                }
            }, 1000); // Dar tiempo al CDN para cargar
        });
        
        // Funci√≥n de diagn√≥stico global
        window.diagnosticoSupabase = function() {
            console.log('=== DIAGN√ìSTICO SUPABASE ===');
            console.log('1. supabase (CDN) existe?', typeof supabase !== 'undefined');
            console.log('2. supabase.createClient existe?', typeof supabase?.createClient !== 'undefined');
            console.log('3. window.supabaseClient existe?', typeof window.supabaseClient !== 'undefined');
            console.log('4. window.usarSupabase:', window.usarSupabase);
            console.log('5. Config URL:', window.SUPABASE_CONFIG.url);
            console.log('6. Config KEY:', window.SUPABASE_CONFIG.key ? '‚úì ' + window.SUPABASE_CONFIG.key.length + ' chars' : '‚úó');
            console.log('============================');
        };
    </script>
    
   <!-- 3. Tu script principal (ACTUALIZADO para usar el cliente correcto) -->
    <script src="scripts/script.js"></script>
    
   <!-- 4. Parche para asegurar compatibilidad -->
    <script>
        // Asegurar que las funciones de script.js usen el cliente correcto
        setTimeout(() => {
            if (window.supabaseClient) {
                // Hacer que window.supabase apunte al cliente
                window.supabase = window.supabaseClient;
                console.log('üîß Compatibilidad establecida: window.supabase = window.supabaseClient');
            }
            
            // Ejecutar diagn√≥stico
            setTimeout(() => {
                window.diagnosticoSupabase();
            }, 1500);
        }, 1000);
    </script>
</body>
</html>